# Data Quality Constraints Example
#
# Defines validation rules and quality constraints for data contracts.
# These constraints are enforced at data ingestion (client-side) to ensure
# only high-quality, compliant data is used for FL training.

constraints_metadata:
  version: "1.0.0"
  owner: "AI/ML Team - Data Engineering"
  description: "Quality constraints for telemetry data in FL"

# Range Validation
# Values outside specified ranges are flagged as outliers
range_constraints:
  - signal: "engine_1_egt"
    description: "Engine exhaust gas temperature"
    unit: "celsius"
    min: 0
    max: 1200
    action_below: "REJECT"  # Temperature cannot be negative
    action_above: "ALERT"   # Potential overheat condition
    justification: "Physical limits based on engine certification"
  
  - signal: "h2_tank_pressure_fwd"
    description: "Forward hydrogen tank pressure"
    unit: "bar"
    min: 0
    max: 350
    action_below: "REJECT"  # Pressure cannot be negative
    action_above: "ALERT"   # Overpressure condition
    justification: "Tank design pressure limit per AS-5780"
  
  - signal: "airspeed_indicated"
    description: "Indicated airspeed"
    unit: "knots"
    min: 0
    max: 400
    action_below: "REJECT"  # Speed cannot be negative
    action_above: "ALERT"   # Exceeds never-exceed speed (Vne)
    justification: "Aircraft flight envelope limits"
  
  - signal: "altitude_pressure"
    description: "Pressure altitude"
    unit: "feet"
    min: -1000
    max: 50000
    action_below: "ALERT"   # Below sea level (possible but unusual)
    action_above: "REJECT"  # Exceeds certified ceiling
    justification: "Aircraft operational envelope"

# Rate of Change Validation
# Detects unrealistic changes between consecutive measurements
rate_of_change_constraints:
  - signal: "h2_tank_pressure_fwd"
    description: "Hydrogen tank pressure rate of change"
    max_delta: 50  # bar/second
    unit: "bar/second"
    window: 1  # seconds
    action_exceed: "ALERT"
    justification: "Rapid pressure changes indicate leak or sensor fault"
  
  - signal: "engine_1_egt"
    description: "Engine exhaust gas temperature rate of change"
    max_delta: 100  # celsius/second
    unit: "celsius/second"
    window: 1  # seconds
    action_exceed: "ALERT"
    justification: "Rapid temperature changes indicate abnormal combustion"
  
  - signal: "altitude_pressure"
    description: "Altitude rate of change (vertical speed)"
    max_delta: 100  # feet/second (6000 ft/min)
    unit: "feet/second"
    window: 1  # seconds
    action_exceed: "ALERT"
    justification: "Exceeds maximum climb/descent rate"

# Enumeration Validation
# Values must be from allowed set
enumeration_constraints:
  - signal: "flight_phase"
    description: "Current flight phase"
    allowed_values:
      - "ground"
      - "taxi"
      - "takeoff"
      - "climb"
      - "cruise"
      - "descent"
      - "approach"
      - "landing"
    action_invalid: "REJECT"
    justification: "Standardized flight phase definitions"
  
  - signal: "quality_indicator"
    description: "Data quality flag"
    allowed_values: [0, 1, 2]  # 0=good, 1=suspect, 2=bad
    action_invalid: "REJECT"
    justification: "Standardized quality codes"

# Consistency Validation
# Cross-signal validation rules
consistency_constraints:
  - name: "H2 tank pressure-temperature relationship"
    description: "Hydrogen tank pressure should follow ideal gas law approximation"
    signals:
      - "h2_tank_pressure_fwd"
      - "h2_tank_temp_fwd"
    condition: "pressure < 400 * (temp / 300)"  # Simplified ideal gas approximation
    action_fail: "WARNING"
    justification: "Physics-based consistency check"
  
  - name: "Airspeed consistency"
    description: "True airspeed should be greater than indicated airspeed at altitude"
    signals:
      - "airspeed_true"
      - "airspeed_indicated"
      - "altitude_pressure"
    condition: "(altitude > 5000) implies (airspeed_true >= airspeed_indicated)"
    action_fail: "WARNING"
    justification: "Aerodynamic relationship validation"
  
  - name: "Engine N1-N2 relationship"
    description: "Core speed (N2) should be higher than fan speed (N1)"
    signals:
      - "engine_1_n1"
      - "engine_1_n2"
    condition: "n2 >= n1"
    action_fail: "WARNING"
    justification: "Engine mechanical relationship"

# Completeness Validation
# Missing data thresholds
completeness_constraints:
  - scope: "per_signal_per_flight"
    max_missing_rate: 0.05  # 5% maximum missing values
    window: "1_hour"
    action_exceed: "ALERT"
  
  - scope: "required_fields"
    fields:
      - "timestamp"
      - "platform_id"
      - "signal_name"
      - "value"
    action_missing: "REJECT"

# Temporal Validation
# Timestamp validation rules
temporal_constraints:
  - constraint: "timestamp_in_past"
    description: "Timestamp must be in the past (not future)"
    max_future_offset: 60  # seconds (allow small clock skew)
    action_fail: "REJECT"
  
  - constraint: "timestamp_not_too_old"
    description: "Reject stale data"
    max_age: 86400  # 24 hours
    action_fail: "REJECT"
  
  - constraint: "monotonic_increasing"
    description: "Timestamps should be monotonically increasing per signal"
    action_fail: "WARNING"

# Statistical Validation
# Outlier detection using statistical methods
statistical_constraints:
  - method: "3_sigma_rule"
    description: "Flag values > 3 standard deviations from mean"
    signals: "all_numeric"
    window: "1_day"
    action_flag: "ALERT"
  
  - method: "IQR_method"
    description: "Interquartile range method for outlier detection"
    signals: "all_numeric"
    multiplier: 1.5
    window: "1_day"
    action_flag: "WARNING"

# Actions on Constraint Violation
action_definitions:
  REJECT:
    description: "Reject message, do not ingest"
    log: true
    alert: true
    quarantine: true
  
  ALERT:
    description: "Accept with quality flag, generate alert"
    log: true
    alert: true
    quality_flag: 1  # suspect
  
  WARNING:
    description: "Accept with warning, log for review"
    log: true
    alert: false
    quality_flag: 1  # suspect

# Validation Reporting
reporting:
  metrics:
    - "constraint_violation_rate"
    - "rejection_rate"
    - "data_quality_score"
  
  frequency: "hourly"
  destination: "12-METRICS/DATA_QUALITY/"
  
  alerting:
    critical_threshold: 0.10  # 10% violation rate
    warning_threshold: 0.05   # 5% violation rate
    channels: ["slack", "email"]

# Related Documents
related_documents:
  - path: "../data_contract.yaml"
    description: "Parent data contract"
  - path: "../../VALIDATION_SCRIPTS/"
    description: "Automated validation scripts"
  - path: "../../../OPERATIONAL_DATA_HUB/02-DATA_INGESTION/DATA_VALIDATION_RULES.md"
    description: "Fleet-wide validation rules"

# Change History
change_history:
  - version: "1.0.0"
    date: "2025-10-11"
    author: "AI/ML Team"
    changes: "Initial constraint definitions"
